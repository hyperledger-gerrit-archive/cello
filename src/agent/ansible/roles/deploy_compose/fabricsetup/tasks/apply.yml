---
- name: Reuse common code
  include_tasks: "{{ playbook_dir }}/../common/config_apply.yml"

- name: Setup and initialize variables
  set_fact:
    current_host: "{{ hostvars[inventory_hostname].inter_name }}"
    clihost: ""
    fabricworkdir: "/opt/fabric/{{ env }}"

- name: Make sure remote working directory exists
  become: true
  become_user: root
  file:
    path: "{{ fabricworkdir }}/run"
    state: directory

- name: Get peer container list
  set_fact:
    peers: |
      {{ peers + [{'org':item.split('@')[1].split('.')[-1],
        'name':item.split('@')[1] | replace('.', '-'),
        'role':item.split('@')[0]}] }}
  with_items: "{{ fabric.network[current_host].peers | default([]) }}"

- name: Get ca container list
  set_fact:
    cas: |
      {{ cas + [{'org':item.split('.')[-1],
        'name':item | replace('.', '-') }] }}
  with_items: "{{ fabric.network[current_host].cas | default([]) }}"

- name: Get orderer container list
  set_fact:
    orderers: |
      {{ orderers + [{'org':item.split('.')[-1],
        'name':item | replace('.', '-') }] }}
  with_items: "{{ fabric.network[current_host].orderers | default([]) }}"

- name: Set zookeeper and kafka container list
  set_fact:
    zookeepers: "{{ fabric.network[current_host].zookeepers | default([]) }}"
    kafkas: "{{ fabric.network[current_host].kafkas | default([]) }}"

- name: Pull certificates from the controller
  copy:
    src: "{{ pjroot }}/vars/{{ env }}/fabric/certs.tgz"
    dest: "{{ fabricworkdir }}/allcerts.tgz"

- name: Unpack the certificates
  unarchive:
    src: "{{ fabricworkdir }}/allcerts.tgz"
    dest: "{{ fabricworkdir }}/run"
    remote_src: true

- name: Process private key files
  template:
    src: "{{ playbook_dir }}/../deploy_compose/certsetup/templates/fabric-ca-server-config.j2"
    dest: "{{ fabricworkdir }}/run/keyfiles/{{ item.org }}/ca/fabric-ca-server-config.yaml"
  with_items: "{{ cas }}"

- name: Get the peer org list
  set_fact:
    peerorgs: "{{ peers | map(attribute='org') | list  | unique | sort }}"

- name: Create peer org member string
  set_fact:
    orgmembers: >-
      {{ peerorgs|map('regex_replace','(.*)',"'\g<1>.member'")|list|join(',') }}

- name: Login to docker repo
  command: "docker login {{ fabric.repo.url }} -u {{ fabric.repo.username }} -p {{ fabric.repo.password }}"
  when: >
    fabric.baseimage_tag | length > 0 and
    fabric.repo.username | default("") | length > 0 and
    fabric.repo.password | default("") | length > 0

- name: Pull necessary container images from the docker hub
  command: "docker pull {{ fabric.repo.url }}{{ item.name }}"
  when: item.flag | length > 0 and fabric.baseimage_tag | length > 0
  with_items:
    - { name: "fabric-ca:{{ fabric.ca.image_tag | default(fabric.baseimage_tag) }}", flag: "{{ cas }}" }
    - { name: "fabric-zookeeper:{{ fabric.helper_tag }}", flag: "{{ zookeepers }}" }
    - { name: "fabric-kafka:{{ fabric.helper_tag }}", flag: "{{ kafkas }}" }
    - { name: "fabric-couchdb:{{ fabric.helper_tag }}", flag: "{{ peers }}" }
    - { name: "fabric-orderer:{{ fabric.baseimage_tag }}", flag: "{{ orderers }}" }
    - { name: "fabric-peer:{{ fabric.baseimage_tag }}", flag: "{{ peers }}" }
    - { name: "fabric-ccenv:{{ fabric.baseimage_tag }}", flag: "{{ peers }}" }
    - { name: "fabric-tools:{{ fabric.baseimage_tag }}", flag: "tools" }
  tags: "pullimages"

- name: Create docker compose files
  template:
    src: "{{ playbook_dir }}/fabricsetup/templates/{{ item.name }}.j2"
    dest: "{{ fabricworkdir }}/run/{{ item.name }}.yml"
  when: item.flag | length > 0
  with_items:
    - { name: "ca-compose", flag: "{{ cas }}" }
    - { name: "zookeeper-compose", flag: "{{ zookeepers }}" }
    - { name: "kafka-compose", flag: "{{ kafkas }}" }
    - { name: "orderer-compose", flag: "{{ orderers }}" }
    - { name: "peer-compose", flag: "{{ peers }}" }

- name: Start fabric components
  command: "docker-compose -p {{ env }}.{{ item.name }} -f {{ fabricworkdir }}/run/{{ item.name }}.yml up -d"
  when: item.flag | length > 0
  with_items:
    - { name: "ca-compose", flag: "{{ cas }}" }
    - { name: "zookeeper-compose", flag: "{{ zookeepers }}" }
    - { name: "kafka-compose", flag: "{{ kafkas }}" }
    - { name: "orderer-compose", flag: "{{ orderers }}" }
    - { name: "peer-compose", flag: "{{ peers }}" }
  tags: "fabricup"

- name: Locate a host to run peer channel create command
  set_fact:
    clihost: "{{ item }}"
    clipeer: "{{ allpeers | random }}"
    cliorderer: "{{ allorderers | random }}"
  when: peers | length > 0 and clihost == ""
  with_items: "{{ groups['allnodes'] }}"

- name: Make sure that working directory exists and clean
  file:
    path: "{{ fabricworkdir }}/run/keyfiles/chaincode"
    state: "directory"
    mode: 0775
  when: clihost == inventory_hostname

- name: Move chaincode to the server
  copy:
    src: "{{ playbook_dir }}/fabricsetup/templates/firstcode.go"
    dest: "{{ fabricworkdir }}/run/keyfiles/chaincode/firstcode.go"
    mode: "u=rw,g=rw"
  when: clihost == inventory_hostname

- name: Create peer channel command script
  template:
    src: "{{ playbook_dir }}/fabricsetup/templates/dochannel.j2"
    dest: "{{ fabricworkdir }}/run/keyfiles/dochannel.sh"
    mode: "u=rx,g=rx"
  when: clihost == inventory_hostname

- name: Create peer channel command docker compose file
  template:
    src: "{{ playbook_dir }}/fabricsetup/templates/cli-compose.j2"
    dest: "{{ fabricworkdir }}/run/cli-compose.yml"
  when: clihost == inventory_hostname

- name: Start fabriccli components
  command: "docker-compose -p {{ env }}.cli -f {{ fabricworkdir }}/run/cli-compose.yml up -d"
  when: clihost == inventory_hostname
  tags: "dochaincode"

- name: Wait for fabriccli to start
  command: >-
    docker ps -a -q -f 'name=fabriccli'
  register: clistatus
  until: clistatus.stdout | length > 0
  retries: 50
  delay: 10
  when: clihost == inventory_hostname
  tags: "dochaincode"

- name: Wait fabriccli to exit
  command: >-
    docker ps -a -q -f 'name=fabriccli' -f 'status=exited'
  register: clistatus
  until: clistatus.stdout | length > 0
  retries: 50
  delay: 10
  when: clihost == inventory_hostname
  tags: "dochaincode"
